---
title: "2297_Yilong_mRNA_stressGranules_DESeq2_MAplots"
output:
  html_document:
    df_print: paged
toc: yes
---

## Custom multiple MA plots for run 2297, 'gene-level' count

- load all necessary objects
  - path: /data/processing2/balan_Yilong/project_2297_45nG7vuc_mRNA-seq/analysis/
  - objects:
    - U vs mock:    DESeq2_corrected_sampleSheet_switch_UL3_to_UH2.Group4/
    - 4sU vs mock:  DESeq2_corrected_sampleSheet_switch_UL3_to_UH2.Group1/
    - 4UH vs mock:  DESeq2_corrected_sampleSheet_switch_UL3_to_UH2.Group2/
    - 4UL vs mock:  DESeq2_corrected_sampleSheet_switch_UL3_to_UH2.Group3/
    - 4UL vs 4UH:   DESeq2_corrected_sampleSheet_only4UH4UL_switch_UL3_to_UH2.tsv_translated
- find necessary data for MA plots
- make a 3x2 multiplot

```{r, load_libraries}
suppressPackageStartupMessages(library(DESeq2))
```


### Load the data 

```{r, load-data}
#dds_4UH_4UL <- load(paste0(common_path, "DESeq2_corrected_sampleSheet_only4UH4UL_switch_UL3_to_UH2.tsv_translated/DEseq_basic_DESeq.Rdata") )
#dds_U_vs_m <- load(paste0(in_dir, "DESeq2_corrected_sampleSheet_switch_UL3_to_UH2.Group4/DEseq_basic_DESeq.Rdata") )
#dds_4sU_vs_m <- load(paste0(in_dir, "DESeq2_corrected_sampleSheet_switch_UL3_to_UH2.Group1/DEseq_basic_DESeq.Rdata") )
#dds_4UH_vs_m <- load(paste0(in_dir, "DESeq2_corrected_sampleSheet_switch_UL3_to_UH2.Group2/DEseq_basic_DESeq.Rdata") )
#dds_4UL_vs_m <- load(paste0(in_dir, "DESeq2_corrected_sampleSheet_switch_UL3_to_UH2.Group3/DEseq_basic_DESeq.Rdata") )

f.load_multiple_R_objects <- function(common_path, dirs, list_objs) {
  v.dt_s <- vector(mode = "list", length = length(list_objs))
  
  for (i in 1:length(list_objs) ) {
    #print(i)
    ## paste the directories and the name of the objects in the correct order!!!
    ## 'common_path' should end in a '/'!!
    load(paste0(common_path, dirs[i], '/', 'DEseq_basic_DESeq.Rdata'))
    assign(paste0('dds', '_', list_objs[i]), dds) 
    assign(paste0('ddr', '_', list_objs[i]), ddr) 
    assign(paste0('ddr_shr', '_', list_objs[i]), ddr_shrunk) 
    
    v.dt_s[[i]] <- list(get(paste0('dds','_',list_objs[i])), get(paste0('ddr','_',list_objs[i])), get(paste0('ddr_shr','_',list_objs[i])) )
    names(v.dt_s)[i] <- list_objs[i]
    }
  return(v.dt_s)
}

work_dir<- '/data/processing2/balan_Yilong/project_2297_45nG7vuc_mRNA-seq/analysis/'
directories <- list("DESeq2_corrected_sampleSheet_only4UH4UL_switch_UL3_to_UH2.tsv_translated", 
             "DESeq2_corrected_sampleSheet_switch_UL3_to_UH2.Group4",
             "DESeq2_corrected_sampleSheet_switch_UL3_to_UH2.Group1",
             "DESeq2_corrected_sampleSheet_switch_UL3_to_UH2.Group2",
             "DESeq2_corrected_sampleSheet_switch_UL3_to_UH2.Group3")
#list_objects <- list('4UH_4UL', 'U_vs_m', '4sU_vs_m', '4UH_vs_m', '4UL_vs_m')
list_objects <- list('4sU+UVAlow_vs_4sU+UVAhigh', 'UVA_vs_mock', '4sU_vs_mock', '4sU+UVAhigh_vs_mock', '4sU+UVAlow_vs_mock')

Rdf <- f.load_multiple_R_objects(work_dir, directories, list_objects)
```


### MA plots

```{r, plot-data}
#THIS OPTION DOESN'T WORK IF YOU NEED TO MOVE PLOT (1,1) - MFG CAN'T REPLACE WHAT IS ALREADY PLOTTED
# op <- par(mfrow = c(2,2),
#           oma = c(5,4,0,0) + 0.1,
#           mar = c(0,0,1,1) + 0.1)
# 
# par(mfrow = c(2, 3),     # 2x3 fill row layout
#     oma = c(5,4,2,1),    # margins for whole plot
#     mar = c(2,4,3.2,1),  # margins for individual plots
#     mgp = c(2, 1, 0)
#     )    # axis label at 2 rows distance, tick labels at 1 row
# 
# yl <- c(-4.5,4.5)
# # plot_order <- c(2, 1,
# #                 1, 1,
# #                 1, 2,
# #                 2, 2,
# #                 2, 3)   # change plot order
# # dim(plot_order) <- c(2, 5)
# 
# for (i in 1:length(list_objects) ) {
#   ## par(mfg = c(k %% 3, k %/% 3) + 1)
#   #par(mfg = plot_order[, i])
#   DESeq2::plotMA(Rdf[[i]][[2]], ylim=yl, alpha=metadata(Rdf[[i]][[2]])$alpha/5, main=list_objects[[i]] , xlab='', ylab='', colSig='red')
#   abline(h=c(-1,1),col="dodgerblue",lwd=2)
#   }
# 
# title(main = paste0("MA plots for DE analysis, alpha=", metadata(Rdf[[i]][[2]])$alpha/5),
#       xlab = "Log fold change",
#       ylab = "Mean expression",
#       outer = TRUE, line = 1)
# 
# par(op)			# reset graphics
```


```{r, tests}
png("./MA_plot.png", width=850, height=475, units = "px", bg = "white")
par(oma = c(3,4,4,1),    # margins for whole plot
    mar = c(3,4,3.2,1)  # margins for individual plots
    ) 

yl <- c(-4.5,4.5)
 
layout(matrix(c(2, 3, 6, 4, 5, 1), 2, 3, byrow=TRUE))
# layout.show(6)
options(scipen=2) # to get scientific notation; the higher, the less the probability of lossing scientific notation
for (i in 1:length(list_objects) ) {
  DESeq2::plotMA(Rdf[[i]][[2]], ylim=yl, alpha=metadata(Rdf[[i]][[2]])$alpha/5, main=list_objects[[i]] , xlab='', ylab='', colSig='red',
                 cex.axis=1.5, cex.main=1.5)
  abline(h=c(-1,1),col="dodgerblue",lwd=2)
  }

title(main = paste0("MA plots for DE analysis, alpha=", metadata(Rdf[[i]][[2]])$alpha/5),
      xlab = "Mean expression",
      ylab = "Log fold change",
      outer = TRUE, line = 1,
      cex.lab=2, cex.main=2)

dev.off()
```